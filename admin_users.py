
import logging
from telegram.error import TelegramError

logger = logging.getLogger(__name__)

# ID —á–∞—Ç–∞ –¥–ª—è –±–∞–∑–æ–≤–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
CHAT_ID = -1002492484357

# ID —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω–∞ (–ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º —Ñ—É–Ω–∫—Ü–∏—è–º)
SUPER_ADMIN_USER_ID = 161007346

# –°–ø–∏—Å–æ–∫ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏ (3 –∫–Ω–æ–ø–∫–∏: —Å–ø–∏—Å–æ–∫ –º–æ–Ω–µ—Ç, –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è, –∞–Ω–∞–ª–∏–∑ –ø–æ —Ç–∏–∫–µ—Ä—É)
ADMIN_USER_IDS = {
    219539208, 
    1356408500, # –ù–æ–≤—ã–π –∞–¥–º–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    # 123456789,  # –ü—Ä–∏–º–µ—Ä –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è - —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –∏ –∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π ID
}

# ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –¥–æ—Å—Ç—É–ø–æ–º –∫ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ –ø—Ä–æ–∫—Å–∏
PROXY_STATS_USER_ID = 161007346

def format_proxy_stats_message(stats):
    """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π –ø—Ä–æ–∫—Å–∏"""
    if stats['total'] == 0:
        return "üö´ –ü—Ä–æ–∫—Å–∏ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã"
    
    message = f"""
üìä **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏ –ø—Ä–æ–∫—Å–∏:**

üî¢ –í—Å–µ–≥–æ –ø—Ä–æ–∫—Å–∏: {stats['total']}
‚úÖ –î–æ—Å—Ç—É–ø–Ω—ã—Ö: {stats['available_count']}
‚öñÔ∏è –¢–µ–∫—É—â–∏–π —Ä–µ–∂–∏–º: –£–º–Ω–∞—è –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ –Ω–∞–≥—Ä—É–∑–∫–∏

üîí **–õ–∏–º–∏—Ç—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:**
‚Ä¢ –ó–∞–ø—Ä–æ—Å–æ–≤ –≤ —Å–µ–∫—É–Ω–¥—É: {stats['limits']['requests_per_second']}
‚Ä¢ –í–µ—Å –≤ –º–∏–Ω—É—Ç—É: {stats['limits']['weight_per_minute']}

üìà **–î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:**
"""
    
    for stat in stats['detailed_stats']:
        status_icon = "‚úÖ" if stat['available'] else "‚ùå"
        proxy_display = stat['url'].replace('http://', '').split('@')[-1] if '@' in stat['url'] else stat['url'].replace('http://', '')
        
        message += f"""
{status_icon} **–ü—Ä–æ–∫—Å–∏ #{stat['index'] + 1}:** `{proxy_display}`
   üìä –ù–∞–≥—Ä—É–∑–∫–∞: {stat['request_load_percent']}% | {stat['weight_load_percent']}%
   üìà –ó–∞–ø—Ä–æ—Å—ã: {stat['requests_last_minute']}/–º–∏–Ω | –í—Å–µ–≥–æ: {stat['total_requests']}
   ‚ùå –û—à–∏–±–∫–∏: {stat['total_errors']}
"""
    
    return message

async def is_chat_member(bot, user_id):
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–º —á–∞—Ç–∞"""
    try:
        member = await bot.get_chat_member(chat_id=CHAT_ID, user_id=user_id)
        # –£—á–∞—Å—Ç–Ω–∏–∫ —á–∞—Ç–∞ –µ—Å–ª–∏ —Å—Ç–∞—Ç—É—Å: member, administrator, creator
        return member.status in ['member', 'administrator', 'creator']
    except TelegramError as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —É—á–∞—Å—Ç–Ω–∏–∫–∞ —á–∞—Ç–∞ {user_id}: {e}")
        return False
    except Exception as e:
        logger.error(f"–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞ {user_id}: {e}")
        return False

def is_super_admin(user_id):
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω–æ–º (–≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏)"""
    return user_id == SUPER_ADMIN_USER_ID

def is_admin_user(user_id):
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º (3 –∫–Ω–æ–ø–∫–∏: —Å–ø–∏—Å–æ–∫ –º–æ–Ω–µ—Ç, –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è, –∞–Ω–∞–ª–∏–∑ –ø–æ —Ç–∏–∫–µ—Ä—É)"""
    return user_id in ADMIN_USER_IDS

def can_view_proxy_stats(user_id):
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –º–æ–∂–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–µ—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø—Ä–æ–∫—Å–∏"""
    return user_id == PROXY_STATS_USER_ID

def get_access_denied_message():
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—Ç–∫–∞–∑–µ –≤ –¥–æ—Å—Ç—É–ø–µ"""
    return "üö´ –î–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –∏–∑–±—Ä–∞–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º.\n\nüí¨ –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞."

async def has_basic_access(bot, user_id):
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –±–∞–∑–æ–≤—ã–π –¥–æ—Å—Ç—É–ø: –ª–∏–±–æ —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω, –ª–∏–±–æ –∞–¥–º–∏–Ω, –ª–∏–±–æ —É—á–∞—Å—Ç–Ω–∏–∫ —á–∞—Ç–∞"""
    return is_super_admin(user_id) or is_admin_user(user_id) or await is_chat_member(bot, user_id)

def get_chat_access_denied_message():
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—Ç–∫–∞–∑–µ –≤ –¥–æ—Å—Ç—É–ø–µ –∫ —á–∞—Ç—É"""
    return "üö´ –î–æ—Å—Ç—É–ø –∫ –±–æ—Ç—É –æ–≥—Ä–∞–Ω–∏—á–µ–Ω.\n\nüí¨ –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞ –≤—Å—Ç—É–ø–∏—Ç–µ –≤ –Ω–∞—à —á–∞—Ç –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É."
